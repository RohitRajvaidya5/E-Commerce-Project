{% extends "base.html" %}
{% load static %}

{% block title %}Cart{% endblock %}

{% block content %}

<style>
  /* Ensure product name stays readable in dark mode */
  html[data-theme="dark"] .cart-item-name { color: #ffffff !important; }
</style>

{% if products %}
    <div class="space-y-4">
      <ul class="divide-y rounded-lg overflow-hidden bg-base-100 shadow-sm">
        {% for p in products %}
        <li class="flex items-center justify-between px-4 py-3">
            <div class="flex items-center gap-4">

                {% if p.image %}
                  <img src="{{ p.image.url }}" alt="{{ p.name }}" class="w-16 h-16 object-cover rounded-md shadow-sm bg-gray-50">
                {% else %}
                  <img src="{% static 'products/images/empty_cart.jpg' %}" alt="{{ p.name }}" class="w-16 h-16 object-cover rounded-md shadow-sm bg-gray-50">
                {% endif %}

                <div>
                    <div class="font-medium text-gray-900 cart-item-name">{{ p.name }}</div>
                    <div class="flex items-center gap-2 mt-2">
                        <button class="btn btn-outline btn-xs" onclick="updateQuantity({{ p.id }}, -1)">-</button>
                        <span class="text-sm font-medium w-8 text-center" id="qty-{{ p.id }}">{{ p.qty }}</span>
                        <button class="btn btn-outline btn-xs" onclick="updateQuantity({{ p.id }}, 1)">+</button>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div class="text-xs text-gray-500">Unit price</div>
                    <div class="font-semibold">₹{{ p.price }}</div>
                    <div class="text-sm text-gray-500 mt-1">
                        Total: <span id="total-{{ p.id }}" class="font-bold text-gray-900">₹{{ p.total }}</span>
                    </div>
                </div>

                <!-- REMOVE (loader enabled) -->
                <a href="{% url 'remove_from_cart' p.id %}" class="text-red-600 hover:text-red-800 link-with-loader">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
                         class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m-3-4v4m-4 0h8"/>
                    </svg>
                </a>
            </div>
        </li>
        {% endfor %}
      </ul>

      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <p class="text-xl font-semibold">
            Total: <span class="text-primary" id="grand-total">₹{{ total }}</span>
        </p>

        <div class="flex gap-3">

          <!-- CHECKOUT (loader enabled) -->
          <a href="{% url 'checkout' %}" class="btn btn-primary link-with-loader">
            Checkout
          </a>

          <!-- CONTINUE SHOPPING (loader enabled) -->
          <a href="{% url 'products' %}" class="btn btn-ghost link-with-loader">
            Continue Shopping
          </a>

        </div>
      </div>
    </div>

{% else %}
    <div class="flex flex-col items-center justify-center py-10 h-[64vh]">
      <img 
        src="{% static 'products/images/empty_cart.jpg' %}" 
        alt="Empty Cart" 
        class="w-48 mb-6 rounded-lg shadow-sm"
      >
      <p class="text-center text-xl text-gray-600 mb-4">Your cart is empty.</p>

      <!-- EMPTY CART button also loader-enabled -->
      <a href="{% url 'products' %}" class="btn btn-primary link-with-loader">
        Start Shopping
      </a>
    </div>

{% endif %}

<script>
async function updateQuantity(productId, delta) {
  const qtySpan = document.getElementById(`qty-${productId}`);
  const totalSpan = document.getElementById(`total-${productId}`);
  
  if (!qtySpan || !totalSpan) return;
  
  const currentQty = parseInt(qtySpan.innerText);
  const newQty = Math.max(1, currentQty + delta);
  
  if (newQty === currentQty) return;
  const oldQty = currentQty;

  try {
    const resp = await fetch(`/update-cart-quantity/${productId}/${newQty}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') }
    });

    if (resp.ok) {
      const data = await resp.json();
      qtySpan.innerText = data.qty;
      totalSpan.innerText = `₹${data.total}`;
      updateGrandTotal();

      window.dispatchEvent(new CustomEvent('cartUpdated', {
        detail: { productId, oldQty, qty: data.qty }
      }));

    } else {
      console.error('Failed to update quantity');
    }
  } catch (err) {
    console.error(err);
  }
}

function updateGrandTotal() {
  let grandTotal = 0;
  document.querySelectorAll('[id^="total-"]').forEach(span => {
    const priceStr = span.innerText.replace('₹', '').trim();
    grandTotal += parseFloat(priceStr) || 0;
  });

  const grandTotalSpan = document.getElementById('grand-total');
  if (grandTotalSpan) {
    grandTotalSpan.innerText = `₹${grandTotal.toLocaleString('en-IN')}`;
  }
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith(name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
          }
      }
  }
  return cookieValue;
}
</script>

{% endblock %}
