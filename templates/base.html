{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" />

    <!-- Tailwind Browser -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet" />

    <style>
      :root {
        --content-max: 1100px;
      }
      html, body {
        font-family: "Inter", system-ui, sans-serif;
      }
      .container-max {
        max-width: var(--content-max);
      }
      header.navbar {
        backdrop-filter: blur(6px);
      }
      .brand-gradient {
        background: linear-gradient(90deg, #7c3aed, #06b6d4);
        -webkit-background-clip: text;
        color: transparent;
      }
      main > .container-inner {
        padding-top: 8px;
        padding-bottom: 24px;
      }
      html[data-theme="dark"] *, html[data-theme="dark"] body {
        color: #fff !important;
      }
    </style>

    <title>{% block title %}My Shop{% endblock %}</title>
  </head>

  <body class="bg-base-200 text-base-content min-h-screen">

    <!-- GLOBAL LOADER -->
    <div id="global-loader"
         class="fixed inset-0 bg-base-200 bg-opacity-80 flex items-center justify-center invisible z-[9999]">
      <div class="bg-base-100 p-8 rounded-xl shadow-lg border border-base-300 flex flex-col items-center">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <p id="global-loader-text" class="mt-4 text-sm font-medium text-base-content">Processing...</p>
      </div>
    </div>

    <script>
      // Only show loader for normal form submits (not Razorpay)
      window._razorpay_processing = false;

      document.addEventListener("submit", function () {
        if (window._razorpay_processing) return;

        document.getElementById("global-loader").classList.remove("invisible");
      });
    </script>

    {% if messages %}
    <div id="messages">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- NAVBAR -->
    <header class="navbar bg-base-100 shadow-sm px-4 md:px-8 sticky top-0 z-50">
      <div class="flex-1">
        <a href="/" class="text-2xl font-semibold brand-gradient">Printora</a>
      </div>

      <div class="flex items-center gap-3">

        <!-- Search -->
        <form action="{% url 'search' %}" method="GET" class="hidden sm:flex items-center">
          <input id="search-input" type="text" name="q"
                 placeholder="Search products..." autocomplete="off"
                 value="{{ request.GET.q }}"
                 class="input input-bordered input-sm pr-3" />

          <button type="submit" class="ml-2 btn btn-square btn-sm">üîç</button>
          <ul id="search-suggestions" class="hidden absolute mt-2 left-0 right-0 bg-base-100 rounded-box shadow p-1"></ul>
        </form>

        <!-- Cart -->
        <a href="{% url 'cart' %}" class="btn btn-ghost btn-circle">
          <div class="indicator">
            üõí
            <span class="badge badge-sm indicator-item" id="cart-badge">{{ cart_items }}</span>
          </div>
        </a>

        <!-- Theme -->
        <label class="swap swap-rotate mr-4">
          <input type="checkbox" id="theme-toggle" class="toggle" />
        </label>

        <!-- Profile -->
        {% if request.user.is_authenticated %}
        <div class="dropdown dropdown-end">
          <div class="avatar btn btn-ghost btn-circle" tabindex="0">
            <div class="w-10 rounded-full">
              {% if request.user.profile.profile_photo %}
                <img src="{{ request.user.profile.profile_photo.url }}" class="w-10 h-10 object-cover rounded-full" />
              {% else %}
                <img src="/static/default_profile.jpg" class="w-10 h-10 object-cover rounded-full" />
              {% endif %}
            </div>
          </div>
          <ul class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
            <li><a href="{% url 'profile' %}">My Profile</a></li>
            <li><a href="{% url 'logout' %}">Logout</a></li>
          </ul>
        </div>
        {% else %}
        <a href="{% url 'login' %}" class="btn btn-primary btn-sm">Login</a>
        {% endif %}
      </div>
    </header>

    <main class="p-6">
      <div class="container-max container-inner mx-auto">
        {% block content %}{% endblock %}
      </div>
    </main>

    <footer class="footer bg-base-300 p-6 mt-12">
      <div class="container-max mx-auto flex justify-between">
        <div>
          <p class="font-semibold">Printora</p>
          <p class="text-sm mt-1">¬© 2025 MyShop ‚Äî All rights reserved.</p>
        </div>

        <nav class="flex gap-4">
          <a class="link link-hover">Privacy Policy</a>
          <a class="link link-hover">Terms of Use</a>
        </nav>
      </div>
    </footer>

    <!-- Theme Script -->
    <script>
      const toggle = document.getElementById("theme-toggle");
      const htmlEl = document.documentElement;
      const savedTheme = localStorage.getItem("theme");

      if (savedTheme) {
        htmlEl.setAttribute("data-theme", savedTheme);
        toggle.checked = savedTheme === "dark";
      }

      toggle.addEventListener("change", () => {
        const newTheme = toggle.checked ? "dark" : "light";
        htmlEl.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
      });
    </script>

    <!-- Search Suggestions -->
    <script>
      const searchBox = document.getElementById("search-suggestions");
      const searchInput = document.getElementById("search-input");

      function debounce(fn, delay) {
        let timeout;
        return (...args) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      async function loadSuggestions(query) {
        if (!query) {
          searchBox.classList.add("hidden");
          searchBox.innerHTML = "";
          return;
        }

        const res = await fetch(`/search-suggestions/?q=${encodeURIComponent(query)}`);
        const data = await res.json();

        if (!data.results.length) {
          searchBox.classList.add("hidden");
          return;
        }

        searchBox.innerHTML = data.results
          .map(p => `<li><a class="block px-3 py-2" href="${p.url}">${p.name}</a></li>`)
          .join("");

        searchBox.classList.remove("hidden");
      }

      if (searchInput) {
        searchInput.addEventListener("input", debounce(() => {
          loadSuggestions(searchInput.value.trim());
        }, 200));
      }
    </script>

    <!-- Flash Message Fade -->
    <script>
      setTimeout(() => {
        const box = document.getElementById("messages");
        if (box) {
          box.style.transition = "opacity .5s";
          box.style.opacity = "0";
          setTimeout(() => box.remove(), 500);
        }
      }, 1000);
    </script>

  </body>
</html>
