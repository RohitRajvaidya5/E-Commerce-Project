{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto px-4 py-10">

    <!-- PRODUCT SECTION -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">

        <!-- LEFT: Images -->
        <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <img
                        src="{{ product.image.url }}"
                        class="w-full h-80 object-contain rounded-lg shadow-md bg-white"
                    />
                </div>
            </div>
        </div>

        <!-- RIGHT: Product Info -->
        <div class="space-y-4">

            <h2 class="text-2xl font-bold">{{ product.name }}</h2>

            <div class="flex items-center gap-3">
                <p class="text-2xl font-semibold">Rs. {{ product.price }}</p>

                {% if product.old_price %}
                    <p class="line-through text-gray-400">Rs. {{ product.old_price }}</p>
                {% endif %}
            </div>

            <p class="text-sm text-green-600">Free Shipping / Including Taxes</p>

            <div class="flex items-center gap-3">
                <span class="w-3 h-3 bg-green-600 rounded-full"></span>
                <p class="text-sm text-gray-700">In stock</p>
            </div>

            <!-- Buttons -->
            <div class="space-y-3 pt-4">

                <!-- AJAX Add to Cart -->
                <button id="add-to-cart-btn"
                        class="cursor-pointer w-full bg-black text-white py-3 rounded-lg"
                        type="button"
                        onclick="addToCartAjax({{ product.id }})">
                    Add To Cart
                </button>

                <!-- Go to Cart (Loader Enabled) -->
                <a href="{% url 'cart' %}"
                   class="w-full block text-center border py-3 rounded-lg link-with-loader">
                    Go To Cart
                </a>
            </div>

            <div class="pt-3 space-y-1 text-sm">
                <div class="flex items-center gap-2">
                    <span>ðŸšš</span> Reliable shipping
                </div>
                <div class="flex items-center gap-2">
                    <span>ðŸ”„</span> 7 day replacement
                </div>
            </div>
        </div>
    </div>

    <!-- DESCRIPTION SECTION -->
    <div class="mt-16 max-w-3xl">
        <h2 class="text-2xl font-semibold mb-3">Description</h2>
        <p class="text-gray-700 leading-relaxed">
            {{ product.description }}
        </p>
    </div>

</div>

<script>
async function addToCartAjax(productId) {
    const btn = document.getElementById('add-to-cart-btn');
    if (!btn) return;
    const orig = btn.innerText;

    try {
        btn.disabled = true;
        btn.innerText = 'Adding...';

        const resp = await fetch(`/add/${productId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });

        if (resp.ok) {
            /* Update Cart Badge */
            const badge = document.getElementById('cart-badge');
            if (badge) {
                const current = parseInt(badge.innerText) || 0;
                badge.innerText = current + 1;
            }

            btn.innerText = 'âœ“ Added';
            btn.classList.remove('bg-black');
            btn.classList.add('bg-green-600');

            setTimeout(() => {
                btn.innerText = orig;
                btn.classList.remove('bg-green-600');
                btn.classList.add('bg-black');
                btn.disabled = false;
            }, 1800);
        } else {
            btn.innerText = 'Error';
            setTimeout(() => { btn.innerText = orig; btn.disabled = false; }, 1500);
        }

    } catch (err) {
        console.error(err);
        btn.innerText = 'Error';
        setTimeout(() => { btn.innerText = orig; btn.disabled = false; }, 1500);
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock content %}
